name: Deploy backend to Azure Web App

on:
  push:
    branches:
      - main
    paths:
      - "index.js"
      - "index_v4.js"
      - "package.json"
      - "package-lock.json"
      - ".github/workflows/deploy.yml"
      - "**/*.js"
      - "*.js"
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: app-kenq-4
  NODE_VERSION: "18.x"  # å®‰å®šç‰ˆã«å¤‰æ›´

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci --omit=dev --prefer-offline
          
      - name: ğŸ§¹ Clean unnecessary files
        run: |
          rm -rf node_modules/.cache || true
          rm -f *.backup *.original *.log || true
          
      - name: ğŸ“‹ Display build info
        run: |
          echo "Node.js version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Package info:"
          cat package.json

      - name: ğŸ—œï¸ Create deployment package
        run: |
          zip -r release.zip . \
            -x ".git/*" \
            -x ".github/*" \
            -x "node_modules/.cache/*" \
            -x "*.backup" \
            -x "*.original" \
            -x "*.log" \
            -x ".env*" \
            -x "deploy.zip"

      - name: ğŸš€ Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: release.zip

      - name: â³ Wait for deployment
        run: |
          echo "Waiting for app to start (extended timeout)..."
          sleep 120  # 2åˆ†å¾…æ©Ÿ

      - name: ğŸ¥ Health Check with retries
        run: |
          echo "Performing health check with retries..."